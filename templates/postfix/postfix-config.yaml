{{- if .Values.postfix.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mail-platform.fullname" . }}-postfix-config
  labels:
    {{- include "mail-platform.postfix.labels" . | nindent 4 }}
data:
  myhostname: {{ .Values.postfix.config.myhostname | quote }}
  mydomain: {{ .Values.postfix.config.mydomain | quote }}
  mynetworks: {{ .Values.postfix.config.mynetworks | quote }}
  
  main.cf: |
    # Basic configuration
    myhostname = {{ .Values.postfix.config.myhostname }}
    mydomain = {{ .Values.postfix.config.mydomain }}
    myorigin = $mydomain
    mydestination = localhost
    
    # Network settings
    inet_interfaces = all
    inet_protocols = ipv4
    mynetworks = {{ .Values.postfix.config.mynetworks }}
    
    # Virtual domains
    virtual_mailbox_domains = {{ .Values.postfix.config.virtual_mailbox_domains }}
    virtual_transport = {{ .Values.postfix.config.virtual_transport }}
    
    # Relay settings
    {{- if .Values.postfix.config.relayhost }}
    relayhost = {{ .Values.postfix.config.relayhost }}
    {{- end }}
    
    # Security settings
    smtpd_tls_cert_file = /etc/ssl/certs/ssl-cert-snakeoil.pem
    smtpd_tls_key_file = /etc/ssl/private/ssl-cert-snakeoil.key
    smtpd_use_tls = yes
    smtpd_tls_security_level = may
    smtp_tls_security_level = may
    
    # SASL authentication
    smtpd_sasl_auth_enable = yes
    smtpd_sasl_type = dovecot
    smtpd_sasl_path = inet:{{ include "mail-platform.fullname" . }}-cyrus-imap:12345
    
    # Restrictions
    smtpd_recipient_restrictions = 
      permit_mynetworks,
      permit_sasl_authenticated,
      reject_unauth_destination
    
    # Content filtering via Amavis
    content_filter = smtp-amavis:[{{ include "mail-platform.fullname" . }}-amavis]:10024
    
    # Message size limit (50MB)
    message_size_limit = 52428800
    mailbox_size_limit = 0
    
  master.cf: |
    # Standard SMTP
    smtp      inet  n       -       n       -       -       smtpd
    
    # Submission port
    submission inet n       -       n       -       -       smtpd
      -o syslog_name=postfix/submission
      -o smtpd_tls_security_level=encrypt
      -o smtpd_sasl_auth_enable=yes
      -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject
    
    # Other services
    pickup    unix  n       -       n       60      1       pickup
    cleanup   unix  n       -       n       -       0       cleanup
    qmgr      unix  n       -       n       300     1       qmgr
    tlsmgr    unix  -       -       n       1000?   1       tlsmgr
    rewrite   unix  -       -       n       -       -       trivial-rewrite
    bounce    unix  -       -       n       -       0       bounce
    defer     unix  -       -       n       -       0       bounce
    trace     unix  -       -       n       -       0       bounce
    verify    unix  -       -       n       -       1       verify
    flush     unix  n       -       n       1000?   0       flush
    proxymap  unix  -       -       n       -       -       proxymap
    proxywrite unix -       -       n       -       1       proxymap
    smtp      unix  -       -       n       -       -       smtp
    relay     unix  -       -       n       -       -       smtp
    showq     unix  n       -       n       -       -       showq
    error     unix  -       -       n       -       -       error
    retry     unix  -       -       n       -       -       error
    discard   unix  -       -       n       -       -       discard
    local     unix  -       n       n       -       -       local
    virtual   unix  -       n       n       -       -       virtual
    lmtp      unix  -       -       n       -       -       lmtp
    anvil     unix  -       -       n       -       1       anvil
    scache    unix  -       -       n       -       1       scache
    
    # Amavis content filter
    smtp-amavis unix -      -       n       -       2       smtp
      -o smtp_data_done_timeout=1200
      -o smtp_send_xforward_command=yes
      -o disable_dns_lookups=yes
      -o max_use=20
    
    # Receive from Amavis
    127.0.0.1:10025 inet n  -       n       -       -       smtpd
      -o content_filter=
      -o local_recipient_maps=
      -o relay_recipient_maps=
      -o smtpd_restriction_classes=
      -o smtpd_client_restrictions=
      -o smtpd_helo_restrictions=
      -o smtpd_sender_restrictions=
      -o smtpd_recipient_restrictions=permit_mynetworks,reject
      -o mynetworks=127.0.0.0/8
      -o smtpd_authorized_xforward_hosts=127.0.0.0/8
{{- end }}
